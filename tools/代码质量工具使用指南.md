# 代码质量工具使用指南

本项目提供了完整的代码质量检查和修复工具链，包括代码格式化（clang-format）和代码静态分析（clang-tidy）。
clang-format版本为14.0.0, clang-tidy版本为14.0.0

## 🛠️ 工具概览

| 工具 | 脚本名称 | 主要功能 | 支持修复 |
|------|----------|----------|----------|
| 格式化检查 | `format_code.py` | 检查代码格式，基于`.clang-format` | ✅ |
| 静态分析 | `lint_code.py` | 检查代码质量，基于`.clang-tidy` | ✅ |
| 综合检查 | `check_code.py` | 同时运行格式化和静态分析 | ✅ |

## 🚀 快速开始

### 1. 检查所有代码质量问题

```bash
# 运行完整的代码质量检查（推荐）
python3 check_code.py

# 仅检查格式化
python3 check_code.py --format-only

# 仅检查静态分析
python3 check_code.py --lint-only
```

### 2. 自动修复问题

```bash
# 自动修复所有问题
python3 check_code.py --fix

# 仅自动修复格式化问题
python3 check_code.py --fix --format-only

# 仅自动修复静态分析问题
python3 check_code.py --fix --lint-only
```

### 3. 分别使用各个工具

```bash
# 格式化工具
python3 format_code.py          # 检查格式
python3 format_code.py --fix    # 修复格式

# 静态分析工具
python3 lint_code.py            # 检查代码质量
python3 lint_code.py --fix      # 修复部分问题
```

## 📋 详细功能说明

### format_code.py - 代码格式化

基于项目的`.clang-format`配置文件检查和修复代码格式。

```bash
python3 format_code.py [选项]

选项:
  --fix         自动修复格式问题
  --no-diff     不显示详细差异
```

**特性:**
- ✅ 支持C/C++/CUDA文件
- ✅ 基于Google代码风格
- ✅ 自动修复功能
- ✅ 详细的差异显示
- ✅ 进度条和友好输出

### lint_code.py - 代码静态分析

基于项目的`.clang-tidy`配置文件进行代码质量检查。

```bash
python3 lint_code.py [选项]

选项:
  --fix           自动修复可修复的问题
  --no-output     不显示详细输出
  --config FILE   指定配置文件（默认: .clang-tidy）
  --all-dirs      检查所有目录（默认只检查kernel/）
```

**特性:**
- ✅ 命名规范检查
- ✅ 现代化C++建议
- ✅ 性能优化建议
- ✅ 核心指导原则检查
- ✅ 静态分析器检查
- ✅ 自动生成编译数据库

### check_code.py - 综合检查

组合运行格式化和静态分析检查。

```bash
python3 check_code.py [选项]

选项:
  --fix           自动修复所有问题
  --format-only   仅运行格式化检查
  --lint-only     仅运行静态分析检查
  --quiet         最小化输出
  --all-dirs      检查所有目录
```

**特性:**
- ✅ 一键运行所有检查
- ✅ 统一的错误报告
- ✅ 灵活的检查模式
- ✅ 批量修复功能

## 📁 检查范围

### 默认检查范围
- **目录**: `./kernel/`
- **文件类型**: `.h`, `.cc`, `.cu`, `.hpp`, `.cpp`, `.c`
- **跳过**: `mnn` 相关文件（如原脚本）

### 扩展检查范围
使用 `--all-dirs` 参数可以检查：
- `./kernel/`
- `./module/`
- `./include/`

## ⚙️ 配置文件

### .clang-format
位置: 项目根目录
功能: 定义代码格式化规则

主要配置:
- 基于Google风格
- 缩进: 4空格
- 行宽: 100字符
- 指针对齐: 左对齐

### .clang-tidy
位置: 项目根目录
功能: 定义静态分析规则

主要检查:
- 命名规范 (readability-identifier-naming)
- 现代化建议 (modernize-*)
- 核心指导原则 (cppcoreguidelines-*)
- 性能优化 (performance-*)
- 静态分析 (clang-analyzer-*)

## 🔧 VS Code集成

项目已配置VS Code自动格式化，保存时会自动运行clang-format。

要启用clang-tidy集成，请安装以下扩展：
- **clangd** (LLVM) - 提供静态分析支持

## 🚀 CI/CD集成

### Git Pre-commit Hook

```bash
#!/bin/bash
echo "Running code quality check..."
python3 check_code.py --quiet
if [ $? -ne 0 ]; then
    echo "❌ Code quality check failed!"
    echo "💡 Run 'python3 check_code.py --fix' to fix issues"
    exit 1
fi
echo "✅ Code quality check passed!"
```

### Makefile集成

```makefile
.PHONY: check format lint fix

# 检查代码质量
check:
	@python3 check_code.py

# 仅检查格式
format:
	@python3 format_code.py

# 仅检查静态分析
lint:
	@python3 lint_code.py

# 修复所有问题
fix:
	@python3 check_code.py --fix

# 快速修复格式问题
format-fix:
	@python3 format_code.py --fix
```

## 📊 使用示例

### 日常开发工作流

```bash
# 1. 开发完成后，检查代码质量
python3 check_code.py

# 2. 如果有问题，查看详细信息
python3 check_code.py --format-only  # 只看格式问题
python3 check_code.py --lint-only    # 只看静态分析

# 3. 自动修复可修复的问题
python3 check_code.py --fix

# 4. 手动修复剩余问题后，重新检查
python3 check_code.py
```

### 批量处理现有代码

```bash
# 1. 检查当前状态
python3 check_code.py --all-dirs

# 2. 先修复格式问题（通常可以100%自动修复）
python3 format_code.py --fix

# 3. 再处理静态分析问题（部分可以自动修复）
python3 lint_code.py --fix --all-dirs

# 4. 最终检查
python3 check_code.py --all-dirs
```

## 🔍 故障排除

### 常见问题

1. **clang-tidy执行失败**
   ```bash
   # 检查clang-tidy是否安装
   clang-tidy --version

   # Ubuntu安装
   sudo apt-get install clang-tidy
   ```

2. **编译错误导致检查失败**
   - 确保项目可以正常编译
   - 检查include路径设置
   - 使用现有的`compile_commands.json`

3. **检查速度慢**
   ```bash
   # 使用静默模式
   python3 lint_code.py --no-output

   # 只检查kernel目录
   python3 lint_code.py  # 默认就是kernel only
   ```

### 调试技巧

```bash
# 查看工具版本
clang-format --version
clang-tidy --version

# 验证配置文件
clang-format --style=file --dump-config | head -10
clang-tidy --list-checks --config-file=.clang-tidy

# 测试单个文件
clang-format -style=file path/to/file.cpp
clang-tidy --config-file=.clang-tidy path/to/file.cpp
```

## 💡 最佳实践

1. **开发前设置**: 配置编辑器自动格式化
2. **开发中**: 定期运行`python3 check_code.py`
3. **提交前**: 运行`python3 check_code.py --fix`
4. **团队协作**: 统一使用相同的配置文件
5. **CI集成**: 在构建流程中添加代码质量检查

## 📈 改进对比

| 功能 | 原脚本 | 新工具 |
|------|--------|--------|
| 错误处理 | 基础 | 完善 |
| 进度显示 | ❌ | ✅ |
| 自动修复 | ❌ | ✅ |
| 友好输出 | ❌ | ✅ |
| 配置检查 | ❌ | ✅ |
| 编译数据库 | ❌ | ✅ |
| 命令行参数 | ❌ | ✅ |
| 超时处理 | ❌ | ✅ |

---

**建议**: 优先使用新的工具脚本(`format_code.py`, `lint_code.py`, `check_code.py`)，它们提供了更好的用户体验和更强大的功能。
